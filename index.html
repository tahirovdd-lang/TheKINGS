<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>THE KINGS ‚Äî –ó–∞–ø–∏—Å—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;
      --surface:rgba(255,255,255,.04);
      --surface2:rgba(0,0,0,.22);
      --stroke:rgba(255,255,255,.10);
      --text:#f5f5f7;
      --muted:rgba(255,255,255,.72);
      --gold:#d4a017;
      --gold2:#b4820a;

      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior:none;
    }

    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:calc(14px + var(--safeT)) calc(12px + var(--safeL)) calc(92px + var(--safeB)) calc(12px + var(--safeR));
    }

    .top{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:56px;height:56px;border-radius:16px;object-fit:cover;border:1px solid var(--stroke)}
    h1{margin:0;font-size:22px}
    p{margin:2px 0 0;color:var(--muted);font-weight:700;letter-spacing:2px}

    .card{border:1px solid var(--stroke);border-radius:18px;padding:14px;margin:12px 0;background:var(--surface)}
    h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}

    input,select,textarea{
      width:100%;
      background:var(--surface2);
      color:var(--text);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px;
      outline:none;
      min-height:48px;
      height:48px;
      line-height:28px;
      appearance:none;
      -webkit-appearance:none;
      font-size:16px;
    }
    textarea{
      resize:none;
      min-height:74px;
      height:auto;
      line-height:1.35;
      font-size:15px;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .field{min-width:0}

    .summary{display:flex;justify-content:space-between;color:var(--muted);margin:12px 0;gap:10px}
    .summary > div{min-width:0}

    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:12px;
      min-height:50px;
      background:linear-gradient(180deg, rgba(212,160,23,.96), rgba(180,130,10,.96));
      font-weight:900;
      cursor:pointer;
      color:#111;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primaryLike{
      background:linear-gradient(180deg, rgba(212,160,23,.96), rgba(180,130,10,.96));
      color:#111;
      border:0;
      font-weight:900;
    }
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(212,160,23,.55);
      color:var(--text);
      font-weight:800;
    }

    .msg{margin-top:10px;color:var(--muted);font-size:13px;white-space:pre-line}
    .promo{border:1px dashed rgba(212,160,23,.35);border-radius:14px;padding:10px;margin:8px 0;background:rgba(212,160,23,.06)}

    a.link{
      color:var(--text);
      text-decoration:none;
      border-bottom:1px dashed rgba(212,160,23,.55);
      padding-bottom:1px;
    }
    a.link:active{opacity:.85}

    .contacts{color:var(--muted);line-height:1.45}
    .contacts b{color:var(--text)}

    .mastersRow{
      display:flex;
      gap:10px;
      overflow:auto;
      padding:4px 2px 2px;
      -webkit-overflow-scrolling: touch;
    }
    .mcard{
      flex:0 0 auto;
      width:110px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .mcard.active{
      border-color:rgba(212,160,23,.7);
      box-shadow:0 0 0 2px rgba(212,160,23,.18) inset;
    }
    .mava{
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--stroke);
      object-fit:cover;
      background:rgba(255,255,255,.06);
      display:block;
      margin:0 auto 8px;
    }
    .mname{font-weight:900}
    .msub{font-size:12px;color:var(--muted);margin-top:2px}

    /* ====== Works grid (4 images, 2x2) ====== */
    .worksTitle{
      margin:14px 0 10px;
      font-weight:900;
      font-size:15px;
      color:var(--text);
    }
    .worksGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .workCard{
      display:block;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      min-height:150px;
    }
    .workImg{
      width:100%;
      height:170px;
      object-fit:cover;
      display:block;
    }
    @media (max-width:360px){
      .workImg{height:150px}
    }

    /* ====== Sheets & FAB (kept) ====== */
    .sheetBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:50;
    }
    .sheetBackdrop.show{display:block}
    .sheet{
      position:absolute;
      left:0; right:0; bottom:0;
      background:#0f0f11;
      border-top:1px solid rgba(255,255,255,.10);
      border-radius:18px 18px 0 0;
      padding:10px 12px calc(12px + var(--safeB));
      transform:translateY(10px);
      animation: sheetUp .16s ease-out forwards;
      max-height:min(82vh, 720px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes sheetUp{to{transform:translateY(0)}}
    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 2px 10px;
      gap:10px;
    }
    .grab{width:52px;height:4px;border-radius:999px;background:rgba(255,255,255,.18);margin:6px auto 8px}
    .sheetTitle{font-weight:900}
    .xbtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      min-height:40px;
    }

    .svcGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .svcCard{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      min-height:92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
    }
    .svcCard.active{
      border-color:rgba(212,160,23,.7);
      box-shadow:0 0 0 2px rgba(212,160,23,.18) inset;
    }
    .svcName{font-weight:900;line-height:1.2}
    .svcSub{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}
    .svcSub span{white-space:nowrap}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .sheetFooterSticky{
      position:sticky;bottom:0;
      padding-top:10px;
      background:linear-gradient(180deg, rgba(15,15,17,0), rgba(15,15,17,.85) 30%, rgba(15,15,17,1));
      margin-top:10px;
    }
    .hintLine{color:var(--muted);font-size:12px;margin-top:6px}

    .fab{
      position:fixed;
      right:14px;
      bottom:calc(14px + var(--safeB));
      z-index:40;
      width:54px;height:54px;border-radius:18px;
      border:1px solid rgba(212,160,23,.35);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .fab:active{transform:translateY(1px)}
    .fab svg{width:24px;height:24px;fill:rgba(212,160,23,.95)}

    .seg{
      display:flex;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;border:0;background:transparent;color:var(--muted);
      padding:10px 8px;cursor:pointer;font-weight:900;min-height:44px;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .seg button.active{color:var(--text);background:rgba(212,160,23,.14)}
    .flag{font-size:18px;line-height:1}

    .bcard{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:14px;padding:10px;margin:8px 0}
    .btop{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .btitle{margin-top:6px;font-weight:900}
    .bsub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.35}

    .hello{font-weight:900;margin:0 0 8px;font-size:16px}

    /* ‚úÖ Profile header: logo + clickable geo/instagram opposite */
    .profileTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:2px 2px 10px;
    }
    .pBrand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .pLogo{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      object-fit:cover;
      flex:0 0 auto;
    }
    .pBrandText{min-width:0}
    .pBrandText .t1{font-weight:900;line-height:1.05}
    .pBrandText .t2{color:var(--muted);font-weight:800;letter-spacing:1.6px;font-size:12px;margin-top:2px}

    .pActions{
      display:flex;
      gap:8px;
      flex:0 0 auto;
    }
    .pIconBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(212,160,23,.35);
      background:rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .pIconBtn:active{transform:translateY(1px)}
    .pIconBtn svg{width:20px;height:20px;fill:rgba(212,160,23,.95)}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <img class="logo" src="./images/logo.jpg" alt="THE KINGS"/>
      <div>
        <h1>THE KINGS</h1>
        <p>BARBERSHOP</p>
      </div>
    </header>

    <div class="card">
      <h2 id="t_booking">–ó–∞–ø–∏—Å—å</h2>

      <label id="t_services">–£—Å–ª—É–≥–∏</label>
      <button id="btnServices" class="btn primaryLike" type="button">–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏</button>
      <div class="msg" id="servicesHint">–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —É—Å–ª—É–≥–∏</div>

      <label id="t_master">–ú–∞—Å—Ç–µ—Ä</label>
      <div id="mastersRow" class="mastersRow"></div>

      <div class="grid2">
        <div class="field">
          <label id="t_date">–î–∞—Ç–∞</label>
          <input id="date" type="date"/>
        </div>
        <div class="field">
          <label id="t_time">–í—Ä–µ–º—è</label>
          <select id="time"></select>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label id="t_name">–ò–º—è</label>
          <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è"/>
        </div>
        <div class="field">
          <label id="t_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" type="tel" placeholder="+998 __ ___ __ __"/>
        </div>
      </div>

      <label id="t_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ä–æ—Ç–∫–æ –ø–æ –±–æ–∫–∞–º"></textarea>

      <div class="summary">
        <div><span id="t_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>: <b id="dur">‚Äî</b> <span id="t_min">–º–∏–Ω</span></div>
        <div><span id="t_total">–°—É–º–º–∞</span>: <b id="sum">‚Äî</b></div>
      </div>

      <button id="btnSend" class="btn" type="button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <div id="msg" class="msg"></div>

      <div class="worksTitle">–†–∞–±–æ—Ç—ã –Ω–∞—à–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</div>
      <div class="worksGrid">
        <a class="workCard" href="#" data-work="1" aria-label="–†–∞–±–æ—Ç–∞ 1">
          <img class="workImg" src="./images/work_1.jpg" alt="Work 1">
        </a>
        <a class="workCard" href="#" data-work="2" aria-label="–†–∞–±–æ—Ç–∞ 2">
          <img class="workImg" src="./images/work_2.jpg" alt="Work 2">
        </a>
        <a class="workCard" href="#" data-work="3" aria-label="–†–∞–±–æ—Ç–∞ 3">
          <img class="workImg" src="./images/work_3.jpg" alt="Work 3">
        </a>
        <a class="workCard" href="#" data-work="4" aria-label="–†–∞–±–æ—Ç–∞ 4">
          <img class="workImg" src="./images/work_4.jpg" alt="Work 4">
        </a>
      </div>
    </div>

    <div class="card">
      <h2 id="t_promos">–ê–∫—Ü–∏–∏</h2>
      <div id="promos"></div>
    </div>

    <div class="card">
      <h2 id="t_contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
      <div class="contacts">
        <div><b>THE KINGS BARBERSHOP</b></div>
        <div>üìç –≥. –°–∞–º–∞—Ä–∫–∞–Ω–¥, –£–ª–∏—Ü–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω—Å–∫–∞—è, 84</div>
        <div>üïò 09:00-22:00</div>
        <div>‚òéÔ∏è +998 98 001 21 07 / +998 90 601 73 71</div>
        <div>Instagram: <span style="color:var(--muted)">@thekings_barbershop___</span></div>
      </div>
    </div>
  </div>

  <button id="fabProfile" class="fab" type="button" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2-8 4.5A1.5 1.5 0 0 0 5.5 20h13A1.5 1.5 0 0 0 20 18.5C20 16 16.42 14 12 14Z"/>
    </svg>
  </button>

  <!-- Services sheet -->
  <div id="servicesBackdrop" class="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="grab"></div>
      <div class="sheetHeader">
        <div class="sheetTitle" id="t_services_pick">–í—ã–±–æ—Ä —É—Å–ª—É–≥</div>
        <button id="servicesClose" class="xbtn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div id="servicesGrid" class="svcGrid"></div>

      <div class="sheetFooterSticky">
        <div class="hr"></div>
        <button id="servicesConfirm" class="btn" type="button" style="display:none">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <div id="servicesConfirmHint" class="hintLine" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Profile sheet -->
  <div id="profileWindow" class="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="grab"></div>
      <div class="sheetHeader">
        <div class="sheetTitle" id="t_profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <button id="profileClose" class="xbtn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <!-- ‚úÖ –®–ê–ü–ö–ê –ü–†–û–§–ò–õ–Ø: –ª–æ–≥–æ—Ç–∏–ø —Å–ª–µ–≤–∞, –∫–Ω–æ–ø–∫–∏ Instagram/Geo —Å–ø—Ä–∞–≤–∞ -->
      <div class="profileTopRow">
        <div class="pBrand">
          <img class="pLogo" src="./images/logo.jpg" alt="THE KINGS">
          <div class="pBrandText">
            <div class="t1">THE KINGS</div>
            <div class="t2">BARBERSHOP</div>
          </div>
        </div>

        <div class="pActions">
          <button id="profileIgBtn" class="pIconBtn" type="button" aria-label="Instagram">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3Zm-5 4.5A5.5 5.5 0 1 1 6.5 14 5.5 5.5 0 0 1 12 8.5Zm0 2A3.5 3.5 0 1 0 15.5 14 3.5 3.5 0 0 0 12 10.5ZM18 7.2a1 1 0 1 1-1-1 1 1 0 0 1 1 1Z"/>
            </svg>
          </button>

          <button id="profileGeoBtn" class="pIconBtn" type="button" aria-label="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5Z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="hello" id="helloLine">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –í–∞—Å</div>
      <div class="tag" id="tgTag">Telegram: ‚Äî</div>

      <label id="t_lang" style="margin-top:12px">–Ø–∑—ã–∫</label>
      <div class="seg" id="langSeg">
        <button type="button" data-lang="ru"><span class="flag">üá∑üá∫</span>RU</button>
        <button type="button" data-lang="uz"><span class="flag">üá∫üáø</span>UZ</button>
        <button type="button" data-lang="en"><span class="flag">üá¨üáß</span>EN</button>
      </div>

      <div id="profileForm">
        <label id="t_login_phone" style="margin-top:12px">–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)</label>
        <input id="profilePhone" type="tel" placeholder="+998 __ ___ __ __"/>

        <label id="t_login_nick">Telegram –Ω–∏–∫</label>
        <input id="profileNick" type="text" placeholder="@username"/>

        <div class="hr"></div>
        <button id="btnSaveProfile" class="btn" type="button">–í–æ–π—Ç–∏ / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div class="hr"></div>

      <button id="btnMyBookings" class="btn secondary" type="button">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>

      <div class="hr"></div>

      <div class="tag" id="t_upcoming_tag">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
      <div id="upcomingList"></div>

      <div class="hr"></div>

      <div class="tag" id="t_past_tag">–ü—Ä–æ—à–µ–¥—à–∏–µ</div>
      <div id="pastList"></div>
    </div>
  </div>

  <script>
    const tg = (typeof window !== "undefined") ? window.Telegram?.WebApp : null;

    const MASTERS = [
      { id: 1, name: "Dilshod", photo: "./images/master_dilshod.jpg" },
      { id: 2, name: "Daler",   photo: "./images/master_daler.jpg" },
      { id: 3, name: "Azim",    photo: "./images/master_azim.jpg" },
    ];

    const SERVICES = [
      { id: 1,  key:"men_haircut", name_ru:"–ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞", name_uz:"Erkaklar soch turmagi", name_en:"Men's haircut", duration:45, price:70000 },
      { id: 2,  key:"kids_haircut", name_ru:"–î–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞ (–¥–æ 14–ª–µ—Ç)", name_uz:"Bolalar soch turmagi (14 yoshgacha)", name_en:"Kids haircut (up to 14)", duration:45, price:50000 },
      { id: 3,  key:"clipper", name_ru:"–ü–æ–¥ –Ω–∞—Å–∞–¥–∫—É", name_uz:"Mashinka bilan", name_en:"Clipper cut", duration:30, price:40000 },
      { id: 4,  key:"beard", name_ru:"–°—Ç—Ä–∏–∂–∫–∞ –ë–æ—Ä–æ–¥—ã", name_uz:"Soqol olish", name_en:"Beard trim", duration:30, price:50000 },
      { id: 5,  key:"styling", name_ru:"–£–∫–ª–∞–¥–∫–∞ –≤–æ–ª–æ—Å", name_uz:"Soch turmagi (ukladka)", name_en:"Hair styling", duration:20, price:40000 },
      { id: 6,  key:"edging", name_ru:"–û–∫–∞–Ω—Ç–æ–≤–∫–∞", name_uz:"Kontur (okantovka)", name_en:"Edging", duration:10, price:30000 },
      { id: 7,  key:"mask", name_ru:"–ú–∞—Å–∫–∞ –¥–ª—è –ª–∏—Ü–∞", name_uz:"Yuz niqobi", name_en:"Face mask", duration:30, price:40000 },
      { id: 8,  key:"wax", name_ru:"–í–æ—Å–∫", name_uz:"Vosk", name_en:"Wax", duration:20, price:15000 },
      { id: 9,  key:"hair_dye", name_ru:"–ü–æ–∫—Ä–∞—Å–∫–∞ –≤–æ–ª–æ—Å", name_uz:"Soch bo'yash", name_en:"Hair coloring", duration:40, price:40000 },
      { id: 10, key:"beard_dye", name_ru:"–ü–æ–∫—Ä–∞—Å–∫–∞ –±–æ—Ä–æ–¥—ã", name_uz:"Soqol bo'yash", name_en:"Beard coloring", duration:30, price:30000 },
      { id: 11, key:"wedding", name_ru:"–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–∏—á—ë—Å–∫–∞", name_uz:"To'y soch turmagi", name_en:"Wedding hairstyle", duration:60, price:400000 },
    ];

    const PROMOS = [
      { title: "–°–∫–∏–¥–∫–∞ 10% —Å—Ç—É–¥–µ–Ω—Ç–∞–º", text: "–ü—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ." },
      { title: "–ö–∞–∂–¥—ã–π 5-–π –≤–∏–∑–∏—Ç -20%", text: "–°–∫–∏–¥–∫–∞ –Ω–∞ —É—Å–ª—É–≥—É –ø–æ –∫–∞—Ä—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞." },
    ];

    const el = (id) => document.getElementById(id);

    const KEY_PROFILE = "tk_profile_v5";
    const KEY_BOOKINGS = "tk_bookings_v5";
    const KEY_LANG = "tk_lang_v4";

    function fmtSum(n){
      const x = Number(n) || 0;
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function todayISO(){
      const d = new Date();
      const p = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    }
    function normalizePhone(p){ return (p || "").trim().replace(/[^\d+]/g, ""); }
    function sheetOpen(backdrop){ backdrop.classList.add("show"); document.body.style.overflow="hidden"; }
    function sheetClose(backdrop){ backdrop.classList.remove("show"); document.body.style.overflow=""; }

    function loadProfile(){ try { return JSON.parse(localStorage.getItem(KEY_PROFILE) || "null"); } catch { return null; } }
    function saveProfile(p){ localStorage.setItem(KEY_PROFILE, JSON.stringify(p)); }
    function loadBookings(){ try { return JSON.parse(localStorage.getItem(KEY_BOOKINGS) || "[]"); } catch { return []; } }
    function saveBookings(arr){ localStorage.setItem(KEY_BOOKINGS, JSON.stringify(arr)); }

    function getLang(){ return (localStorage.getItem(KEY_LANG) || "ru").toLowerCase(); }
    function setLang(lang){ localStorage.setItem(KEY_LANG, lang); }

    const I18N = {
      ru: {
        booking:"–ó–∞–ø–∏—Å—å", services:"–£—Å–ª—É–≥–∏", pickServices:"–í—ã–±–æ—Ä —É—Å–ª—É–≥", chooseServices:"–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏", notChosen:"–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —É—Å–ª—É–≥–∏",
        master:"–ú–∞—Å—Ç–µ—Ä", date:"–î–∞—Ç–∞", time:"–í—Ä–µ–º—è", name:"–ò–º—è", phone:"–¢–µ–ª–µ—Ñ–æ–Ω", comment:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        commentPh:"–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ä–æ—Ç–∫–æ –ø–æ –±–æ–∫–∞–º", duration:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", min:"–º–∏–Ω", total:"–°—É–º–º–∞",
        confirm:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å", confirmShort:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
        pickServiceFirst:"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É (–∫–Ω–æ–ø–∫–∞ ¬´–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏¬ª).", pickMaster:"–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞.", pickDate:"–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.",
        pickTime:"–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.", enterName:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è.",
        promos:"–ê–∫—Ü–∏–∏", contacts:"–ö–æ–Ω—Ç–∞–∫—Ç—ã", close:"–ó–∞–∫—Ä—ã—Ç—å",
        profile:"–ü—Ä–æ—Ñ–∏–ª—å", lang:"–Ø–∑—ã–∫", loginPhone:"–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)", tgNick:"Telegram –Ω–∏–∫",
        myBookings:"–ú–æ–∏ –∑–∞–ø–∏—Å–∏", upcoming:"–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ", past:"–ü—Ä–æ—à–µ–¥—à–∏–µ",
        noneUpcoming:"–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.", nonePast:"–ü—Ä–æ—à–µ–¥—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.",
        testHint:"‚úÖ (–¢–µ—Å—Ç) –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram WebApp —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.",
        hello:"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –í–∞—Å"
      },
      uz: {
        booking:"Yozilish", services:"Xizmatlar", pickServices:"Xizmat tanlash", chooseServices:"Xizmatlarni tanlash", notChosen:"Xizmat tanlanmagan",
        master:"Usta", date:"Sana", time:"Vaqt", name:"Ism", phone:"Telefon", comment:"Izoh",
        commentPh:"Masalan: yonlari qisqa", duration:"Davomiyligi", min:"daq", total:"Jami",
        confirm:"Yozilishni tasdiqlash", confirmShort:"Tasdiqlash",
        pickServiceFirst:"Xizmat tanlang (\"Xizmatlarni tanlash\" tugmasi).", pickMaster:"Ustani tanlang.", pickDate:"Sanani tanlang.",
        pickTime:"Vaqtni tanlang.", enterName:"Ism kiriting.",
        promos:"Aksiyalar", contacts:"Kontaktlar", close:"Yopish",
        profile:"Profil", lang:"Til", loginPhone:"Telefon (kirish uchun)", tgNick:"Telegram nik",
        myBookings:"Mening yozilishlarim", upcoming:"Kelajakdagi", past:"O‚Äòtgan",
        noneUpcoming:"Kelajakdagi yozilish yo‚Äòq.", nonePast:"O‚Äòtgan yozilish yo‚Äòq.",
        testHint:"‚úÖ (Test) Telegram WebApp orqali oching.",
        hello:"Xush kelibsiz"
      },
      en: {
        booking:"Booking", services:"Services", pickServices:"Pick services", chooseServices:"Choose services", notChosen:"No services selected",
        master:"Master", date:"Date", time:"Time", name:"Name", phone:"Phone", comment:"Comment",
        commentPh:"For example: short on sides", duration:"Duration", min:"min", total:"Total",
        confirm:"Confirm booking", confirmShort:"Confirm",
        pickServiceFirst:"Choose a service (\"Choose services\" button).", pickMaster:"Choose a master.", pickDate:"Choose a date.",
        pickTime:"Choose time.", enterName:"Enter your name.",
        promos:"Promotions", contacts:"Contacts", close:"Close",
        profile:"Profile", lang:"Language", loginPhone:"Phone (login)", tgNick:"Telegram username",
        myBookings:"My bookings", upcoming:"Upcoming", past:"Past",
        noneUpcoming:"No upcoming bookings.", nonePast:"No past bookings.",
        testHint:"‚úÖ (Test) Open via Telegram WebApp to send.",
        hello:"Welcome"
      }
    };

    function svcNameByLang(s, lang){
      if (lang === "uz") return s.name_uz;
      if (lang === "en") return s.name_en;
      return s.name_ru;
    }

    function parseBookingDateTimeISO(dateStr, timeStr){
      const [y,m,d] = dateStr.split("-").map(Number);
      const [hh,mm] = timeStr.split(":").map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0).getTime();
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (tg) {
        tg.ready();
        tg.expand();
        setTimeout(()=>{ try{ tg.expand(); }catch(e){} }, 120);
        try { tg.setHeaderColor && tg.setHeaderColor("#0b0b0c"); } catch(e){}
        try { tg.setBackgroundColor && tg.setBackgroundColor("#0b0b0c"); } catch(e){}
      }
      window.scrollTo(0,0);

      const mastersRow = el("mastersRow");

      const btnServices = el("btnServices");
      const servicesHint = el("servicesHint");
      const servicesBackdrop = el("servicesBackdrop");
      const servicesClose = el("servicesClose");
      const servicesGrid = el("servicesGrid");
      const servicesConfirm = el("servicesConfirm");
      const servicesConfirmHint = el("servicesConfirmHint");

      const dateEl = el("date");
      const timeEl = el("time");
      const nameEl = el("name");
      const phoneEl = el("phone");
      const commentEl = el("comment");
      const durEl = el("dur");
      const sumEl = el("sum");
      const msgEl = el("msg");
      const promosEl = el("promos");
      const btnSend = el("btnSend");

      const fabProfile = el("fabProfile");
      const profileWindow = el("profileWindow");
      const profileClose = el("profileClose");
      const helloLine = el("helloLine");
      const profileForm = el("profileForm");
      const profilePhone = el("profilePhone");
      const profileNick = el("profileNick");
      const btnSaveProfile = el("btnSaveProfile");
      const btnMyBookings = el("btnMyBookings");
      const upcomingList = el("upcomingList");
      const pastList = el("pastList");
      const tgTag = el("tgTag");
      const langSeg = el("langSeg");

      // ‚úÖ Profile header icon buttons
      const profileIgBtn = el("profileIgBtn");
      const profileGeoBtn = el("profileGeoBtn");

      // ‚úÖ Links
      const IG_URL = "https://instagram.com/thekings_barbershop___";
      const YANDEX_ROUTE = "https://yandex.uz/maps/org/228446087424/?ll=66.947459%2C39.643585&z=17.08";

      // ‚úÖ Make clickable
      profileIgBtn.onclick = () => {
        if (tg?.openLink) tg.openLink(IG_URL);
        else window.open(IG_URL, "_blank");
      };
      profileGeoBtn.onclick = () => {
        if (tg?.openLink) tg.openLink(YANDEX_ROUTE);
        else window.open(YANDEX_ROUTE, "_blank");
      };

      // Works -> instagram
      document.querySelectorAll(".workCard").forEach(a=>{
        a.addEventListener("click", (e)=>{
          e.preventDefault();
          if (tg?.openLink) tg.openLink(IG_URL);
          else window.open(IG_URL, "_blank");
        });
      });

      let selectedServices = new Set();
      let selectedMasterId = null;

      function setMsg(t){ msgEl.textContent = t || ""; }
      function strings(){ return I18N[getLang()] || I18N.ru; }

      function getTelegramUser(){
        const u = tg?.initDataUnsafe?.user;
        return {
          firstName: u?.first_name || "",
          username: u?.username ? ("@" + u.username) : ""
        };
      }

      function applyLang(){
        const s = strings();
        el("t_booking").textContent = s.booking;
        el("t_services").textContent = s.services;
        el("t_master").textContent = s.master;
        el("t_date").textContent = s.date;
        el("t_time").textContent = s.time;
        el("t_name").textContent = s.name;
        el("t_phone").textContent = s.phone;
        el("t_comment").textContent = s.comment;
        el("t_duration").textContent = s.duration;
        el("t_min").textContent = s.min;
        el("t_total").textContent = s.total;
        el("t_promos").textContent = s.promos;
        el("t_contacts").textContent = s.contacts;

        commentEl.placeholder = s.commentPh;

        btnServices.textContent = s.chooseServices;
        el("t_services_pick").textContent = s.pickServices;
        servicesClose.textContent = s.close;

        btnSend.textContent = s.confirm;
        servicesConfirm.textContent = s.confirmShort;

        el("t_profile").textContent = s.profile;
        profileClose.textContent = s.close;
        el("t_lang").textContent = s.lang;
        el("t_login_phone").textContent = s.loginPhone;
        el("t_login_nick").textContent = s.tgNick;
        btnMyBookings.textContent = s.myBookings;
        el("t_upcoming_tag").textContent = s.upcoming;
        el("t_past_tag").textContent = s.past;

        [...langSeg.querySelectorAll("button[data-lang]")].forEach(b=>{
          b.classList.toggle("active", b.dataset.lang === getLang());
        });

        updateHello();
        renderServicesSheet();
        calc();
        renderBookings();
      }

      function updateHello(){
        const s = strings();
        const prof = loadProfile() || {};
        const clientName = (prof.name || "").trim();
        helloLine.textContent = clientName ? `${s.hello} (${clientName})` : s.hello;
      }

      function calc(){
        let total = 0, dur = 0;
        const chosen = [];
        const lang = getLang();

        for (const id of selectedServices) {
          const svc = SERVICES.find(x => x.id === id);
          if (!svc) continue;
          total += svc.price;
          dur += svc.duration;
          chosen.push({ id: svc.id, key: svc.key, name: svcNameByLang(svc, lang), price: svc.price, duration: svc.duration, qty: 1 });
        }

        durEl.textContent = dur ? String(dur) : "‚Äî";
        sumEl.textContent = total ? `${fmtSum(total)} so'm` : "‚Äî";

        const s = strings();
        servicesHint.textContent = chosen.length ? chosen.map(x=>x.name).join(" ‚Ä¢ ") : s.notChosen;

        if (chosen.length){
          servicesConfirm.style.display = "";
          servicesConfirmHint.style.display = "";
          servicesConfirmHint.textContent = `${fmtSum(total)} so'm ‚Ä¢ ${dur} ${s.min}`;
        } else {
          servicesConfirm.style.display = "none";
          servicesConfirmHint.style.display = "none";
          servicesConfirmHint.textContent = "";
        }

        return { total, dur, chosen };
      }

      function buildTimes(){
        const start = 9*60, end = 22*60, step = 30;
        timeEl.innerHTML = "";
        for (let t=start; t<end; t+=step){
          const h = String(Math.floor(t/60)).padStart(2,"0");
          const m = String(t%60).padStart(2,"0");
          const opt = document.createElement("option");
          opt.value = `${h}:${m}`;
          opt.textContent = `${h}:${m}`;
          timeEl.appendChild(opt);
        }
      }

      function renderServicesSheet(){
        servicesGrid.innerHTML = "";
        const lang = getLang();
        SERVICES.forEach(svc => {
          const d = document.createElement("div");
          d.className = "svcCard" + (selectedServices.has(svc.id) ? " active" : "");
          d.innerHTML = `
            <div class="svcName">${svcNameByLang(svc, lang)}</div>
            <div class="svcSub">
              <span>${fmtSum(svc.price)} so'm</span>
              <span>${svc.duration} ${strings().min}</span>
            </div>
          `;
          d.onclick = () => {
            if (selectedServices.has(svc.id)) selectedServices.delete(svc.id);
            else selectedServices.add(svc.id);
            renderServicesSheet();
            calc();
          };
          servicesGrid.appendChild(d);
        });
      }

      btnServices.onclick = () => { renderServicesSheet(); calc(); sheetOpen(servicesBackdrop); };
      servicesClose.onclick = () => sheetClose(servicesBackdrop);
      servicesBackdrop.addEventListener("click", (e) => { if (e.target === servicesBackdrop) sheetClose(servicesBackdrop); });
      servicesConfirm.onclick = () => sheetClose(servicesBackdrop);

      function renderMasters(){
        mastersRow.innerHTML = "";
        MASTERS.forEach(m => {
          const c = document.createElement("div");
          c.className = "mcard" + (selectedMasterId === m.id ? " active" : "");
          c.innerHTML = `
            <img class="mava" src="${m.photo}" alt="${m.name}"
              onerror="this.style.opacity='.45'; this.style.filter='grayscale(1)';"/>
            <div class="mname">${m.name}</div>
            <div class="msub">–º–∞—Å—Ç–µ—Ä</div>
          `;
          c.onclick = () => { selectedMasterId = m.id; renderMasters(); setMsg(""); };
          mastersRow.appendChild(c);
        });
      }

      // promos
      promosEl.innerHTML = "";
      PROMOS.forEach(p => {
        const d = document.createElement("div");
        d.className = "promo";
        d.innerHTML = `<b>${p.title}</b><div>${p.text}</div>`;
        promosEl.appendChild(d);
      });

      // language switch
      langSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-lang]");
        if (!btn) return;
        setLang(btn.dataset.lang);
        const prof = loadProfile() || {};
        prof.lang = getLang();
        saveProfile(prof);
        applyLang();
      });

      function bookingCardHTML(x){
        const svc = (x.services || []).map(s => s.name).join(", ");
        return `
          <div class="bcard">
            <div class="btop">
              <div>${x.date} ${x.time}</div>
              <div>${fmtSum(x.total)} so'm</div>
            </div>
            <div class="btitle">${x.master_name || "‚Äî"}</div>
            <div class="bsub">${svc || ""}</div>
          </div>
        `;
      }

      function renderBookings(){
        const s = strings();
        const list = loadBookings();
        const now = Date.now();

        const withTs = list.map(b => {
          const ts = (b.datetime_ts != null) ? Number(b.datetime_ts)
            : (b.date && b.time ? parseBookingDateTimeISO(b.date, b.time) : 0);
          return { ...b, datetime_ts: ts };
        });
        saveBookings(withTs);

        const upcoming = withTs.filter(b => (b.datetime_ts||0) >= (now - 5*60*1000)).sort((a,b)=> (a.datetime_ts||0)-(b.datetime_ts||0));
        const past = withTs.filter(b => (b.datetime_ts||0) < (now - 5*60*1000)).sort((a,b)=> (b.datetime_ts||0)-(a.datetime_ts||0));

        upcomingList.innerHTML = upcoming.length ? upcoming.map(bookingCardHTML).join("") : `<div class="msg">${s.noneUpcoming}</div>`;
        pastList.innerHTML = past.length ? past.map(bookingCardHTML).join("") : `<div class="msg">${s.nonePast}</div>`;
      }

      btnMyBookings.onclick = renderBookings;

      function openProfile(){
        const prof = loadProfile() || {};
        const tgU = getTelegramUser();

        if (tgU.username) prof.nick = tgU.username;

        const nameMain = (nameEl.value || "").trim();
        if (!prof.name && (nameMain || tgU.firstName)) prof.name = nameMain || tgU.firstName;

        prof.lang = prof.lang || getLang();
        saveProfile(prof);

        tgTag.textContent = "Telegram: " + (prof.nick || "‚Äî");
        profileNick.value = prof.nick || "";
        profilePhone.value = prof.phone || "";

        const savedEnough = !!(prof.phone || prof.nick || prof.name);
        profileForm.style.display = savedEnough ? "none" : "";

        updateHello();
        renderBookings();
        sheetOpen(profileWindow);
      }

      profileClose.onclick = () => sheetClose(profileWindow);
      profileWindow.addEventListener("click", (e) => { if (e.target === profileWindow) sheetClose(profileWindow); });
      fabProfile.onclick = openProfile;

      btnSaveProfile.onclick = () => {
        const prof = loadProfile() || {};
        const tgU = getTelegramUser();

        const phone = normalizePhone(profilePhone.value);
        const nick = tgU.username || (profileNick.value || "").trim();
        const nameMain = (nameEl.value || "").trim();
        const nameFinal = (prof.name || nameMain || tgU.firstName || "").trim();

        saveProfile({
          ...prof,
          phone: phone || prof.phone || "",
          nick: nick || prof.nick || "",
          name: nameFinal || prof.name || "",
          lang: getLang(),
          updated_at: Date.now()
        });

        profileForm.style.display = "none";
        tgTag.textContent = "Telegram: " + (nick || "‚Äî");
        updateHello();
      };

      // init
      const prof0 = loadProfile();
      if (prof0?.lang) setLang(prof0.lang);

      dateEl.value = todayISO();
      buildTimes();
      renderMasters();

      const tgU0 = getTelegramUser();
      if (tgU0.firstName && !nameEl.value) nameEl.value = tgU0.firstName;

      nameEl.addEventListener("input", () => {
        const prof = loadProfile() || {};
        prof.name = nameEl.value.trim();
        saveProfile(prof);
        updateHello();
      });

      applyLang();
      calc();

      btnSend.onclick = () => {
        const s = strings();
        const { total, dur, chosen } = calc();

        if (!chosen.length) return setMsg(s.pickServiceFirst);
        if (!selectedMasterId) return setMsg(s.pickMaster);
        if (!dateEl.value) return setMsg(s.pickDate);
        if (!timeEl.value) return setMsg(s.pickTime);
        if (!nameEl.value.trim()) return setMsg(s.enterName);

        const masterName = (MASTERS.find(m => m.id === selectedMasterId)?.name) || "‚Äî";
        const prof = loadProfile() || {};
        const tgU = getTelegramUser();

        const payload = {
          booking_id: "BK-" + Date.now(),
          client_name: nameEl.value.trim(),
          phone: normalizePhone(phoneEl.value) || prof.phone || "",
          comment: commentEl.value.trim(),
          master_id: selectedMasterId,
          master_name: masterName,
          date: dateEl.value,
          time: timeEl.value,
          services: chosen,
          total: total,
          duration_min: dur,
          client_ts: Date.now(),
          lang: getLang(),
          datetime_ts: parseBookingDateTimeISO(dateEl.value, timeEl.value),
          profile_name: (prof.name || nameEl.value.trim() || tgU.firstName || ""),
          profile_nick: (prof.nick || tgU.username || ""),
        };

        const list = loadBookings();
        list.push(payload);
        saveBookings(list);

        if (tg) {
          tg.sendData(JSON.stringify(payload));
          tg.close();
        } else {
          console.log("Payload:", payload);
          setMsg(s.testHint);
        }
      };
    });
  </script>
</body>
</html>
