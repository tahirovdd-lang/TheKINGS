<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>THE KINGS ‚Äî –ó–∞–ø–∏—Å—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;
      --surface:rgba(255,255,255,.04);
      --surface2:rgba(0,0,0,.22);
      --stroke:rgba(255,255,255,.10);
      --text:#f5f5f7;
      --muted:rgba(255,255,255,.72);
      --gold:#d4a017;
      --gold2:#b4820a;

      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:calc(14px + var(--safeT)) calc(12px + var(--safeL)) calc(82px + var(--safeB)) calc(12px + var(--safeR));
    }

    .top{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:56px;height:56px;border-radius:16px;object-fit:cover;border:1px solid var(--stroke)}
    h1{margin:0;font-size:22px}
    p{margin:2px 0 0;color:var(--muted);font-weight:700;letter-spacing:2px}

    .card{border:1px solid var(--stroke);border-radius:18px;padding:14px;margin:12px 0;background:var(--surface)}
    h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}

    input,select,textarea{
      width:100%;
      background:var(--surface2);
      color:var(--text);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px;
      outline:none;
      min-height:44px;
    }
    textarea{resize:none; min-height:64px}

    /* ‚úÖ —Ñ–∏–∫—Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è + –∞–¥–∞–ø—Ç–∏–≤ */
    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width:420px){
      .grid2{grid-template-columns:1fr 1fr;}
    }
    .field{min-width:0}

    .summary{display:flex;justify-content:space-between;color:var(--muted);margin:12px 0;gap:10px}
    .summary > div{min-width:0}

    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:12px;
      min-height:48px;
      background:linear-gradient(180deg, rgba(212,160,23,.96), rgba(180,130,10,.96));
      font-weight:900;
      cursor:pointer;
      color:#111;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(212,160,23,.55);
      color:var(--text);
      font-weight:800;
    }

    .msg{margin-top:10px;color:var(--muted);font-size:13px;white-space:pre-line}
    .promo{border:1px dashed rgba(212,160,23,.35);border-radius:14px;padding:10px;margin:8px 0;background:rgba(212,160,23,.06)}
    .contacts{color:var(--muted);line-height:1.35}

    /* ====== Masters row ====== */
    .mastersRow{
      display:flex;
      gap:10px;
      overflow:auto;
      padding:4px 2px 2px;
      -webkit-overflow-scrolling: touch;
    }
    .mcard{
      flex:0 0 auto;
      width:110px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .mcard.active{
      border-color:rgba(212,160,23,.7);
      box-shadow:0 0 0 2px rgba(212,160,23,.18) inset;
    }
    .mava{
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--stroke);
      object-fit:cover;
      background:rgba(255,255,255,.06);
      display:block;
      margin:0 auto 8px;
    }
    .mname{font-weight:900}
    .msub{font-size:12px;color:var(--muted);margin-top:2px}

    /* ====== Bottom sheets ====== */
    .sheetBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:50;
      padding:0;
    }
    .sheetBackdrop.show{display:block}

    .sheet{
      position:absolute;
      left:0; right:0; bottom:0;
      background:#0f0f11;
      border-top:1px solid rgba(255,255,255,.10);
      border-radius:18px 18px 0 0;
      padding:10px 12px calc(12px + var(--safeB));
      transform:translateY(10px);
      animation: sheetUp .16s ease-out forwards;
      max-height:min(82vh, 680px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes sheetUp{to{transform:translateY(0)}}

    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 2px 10px;
      gap:10px;
    }
    .grab{
      width:52px;height:4px;border-radius:999px;background:rgba(255,255,255,.18);
      margin:6px auto 8px;
    }
    .sheetTitle{font-weight:900}
    .xbtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      min-height:40px;
    }

    /* ‚úÖ —É—Å–ª—É–≥–∏ 2 –≤ —Ä—è–¥ (–±–µ–∑ —ç–º–æ–¥–∑–∏) */
    .svcGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .svcCard{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      min-height:86px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
    }
    .svcCard.active{
      border-color:rgba(212,160,23,.7);
      box-shadow:0 0 0 2px rgba(212,160,23,.18) inset;
    }
    .svcName{font-weight:900; line-height:1.2}
    .svcSub{font-size:12px;color:var(--muted); display:flex; justify-content:space-between; gap:8px}
    .svcSub span{white-space:nowrap}

    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .rowBtns{display:flex;gap:10px}
    .rowBtns .btn{flex:1}

    .tag{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.04);
    }

    /* ====== Floating profile button ====== */
    .fab{
      position:fixed;
      right:14px;
      bottom:calc(14px + var(--safeB));
      z-index:40;
      width:54px;height:54px;border-radius:18px;
      border:1px solid rgba(212,160,23,.35);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .fab:active{transform:translateY(1px)}
    .fab svg{width:24px;height:24px;fill:rgba(212,160,23,.95)}

    /* language segmented */
    .seg{
      display:flex;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 8px;
      cursor:pointer;
      font-weight:800;
      min-height:42px;
    }
    .seg button.active{
      color:var(--text);
      background:rgba(212,160,23,.14);
    }

    /* bookings list cards */
    .bcard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
      margin:8px 0;
    }
    .btop{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .btitle{margin-top:6px;font-weight:900}
    .bsub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <img class="logo" src="./logo.jpg" alt="THE KINGS"/>
      <div>
        <h1>THE KINGS</h1>
        <p>BARBERSHOP</p>
      </div>
    </header>

    <div class="card">
      <h2 id="t_booking">–ó–∞–ø–∏—Å—å</h2>

      <label id="t_services">–£—Å–ª—É–≥–∏</label>
      <button id="btnServices" class="btn secondary" type="button">–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏</button>
      <div class="msg" id="servicesHint">–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —É—Å–ª—É–≥–∏</div>

      <label id="t_master">–ú–∞—Å—Ç–µ—Ä</label>
      <div id="mastersRow" class="mastersRow"></div>

      <div class="grid2">
        <div class="field">
          <label id="t_date">–î–∞—Ç–∞</label>
          <input id="date" type="date"/>
        </div>
        <div class="field">
          <label id="t_time">–í—Ä–µ–º—è</label>
          <select id="time"></select>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label id="t_name">–ò–º—è</label>
          <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è"/>
        </div>
        <div class="field">
          <label id="t_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" type="tel" placeholder="+998 __ ___ __ __"/>
        </div>
      </div>

      <label id="t_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ä–æ—Ç–∫–æ –ø–æ –±–æ–∫–∞–º"></textarea>

      <div class="summary">
        <div><span id="t_duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>: <b id="dur">‚Äî</b> <span id="t_min">–º–∏–Ω</span></div>
        <div><span id="t_total">–°—É–º–º–∞</span>: <b id="sum">‚Äî</b></div>
      </div>

      <button id="btnSend" class="btn" type="button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2 id="t_promos">–ê–∫—Ü–∏–∏</h2>
      <div id="promos"></div>
    </div>

    <div class="card">
      <h2 id="t_contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
      <div class="contacts" id="contactsBox">
        <div><b>THE KINGS BARBERSHOP</b></div>
        <div>üìç –≥. –°–∞–º–∞—Ä–∫–∞–Ω–¥, –£–ª–∏—Ü–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω—Å–∫–∞—è, 84</div>
        <div>üïò 09:00-22:00</div>
        <div>‚òéÔ∏è +998 98 001 21 07 / +998 90 601 73 71</div>
        <div>Instagram: @thekings_barbershop_sam</div>
      </div>
    </div>
  </div>

  <!-- Floating profile button -->
  <button id="fabProfile" class="fab" type="button" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2-8 4.5A1.5 1.5 0 0 0 5.5 20h13A1.5 1.5 0 0 0 20 18.5C20 16 16.42 14 12 14Z"/>
    </svg>
  </button>

  <!-- Services bottom sheet -->
  <div id="servicesBackdrop" class="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="grab"></div>
      <div class="sheetHeader">
        <div class="sheetTitle" id="t_services_pick">–í—ã–±–æ—Ä —É—Å–ª—É–≥</div>
        <button id="servicesClose" class="xbtn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="servicesGrid" class="svcGrid"></div>
      <div class="hr"></div>
      <div class="rowBtns">
        <button id="servicesClear" class="btn secondary" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button id="servicesDone" class="btn" type="button">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Profile WINDOW (–æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ) -->
  <div id="profileWindow" class="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="grab"></div>
      <div class="sheetHeader">
        <div class="sheetTitle" id="t_profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <button id="profileClose" class="xbtn" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tag" id="tgTag">Telegram: ‚Äî</div>

      <label id="t_lang" style="margin-top:12px">–Ø–∑—ã–∫</label>
      <div class="seg" id="langSeg">
        <button type="button" data-lang="ru">RU</button>
        <button type="button" data-lang="uz">UZ</button>
        <button type="button" data-lang="en">EN</button>
      </div>

      <label id="t_login_phone" style="margin-top:12px">–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)</label>
      <input id="profilePhone" type="tel" placeholder="+998 __ ___ __ __"/>

      <label id="t_login_nick">Telegram –Ω–∏–∫</label>
      <input id="profileNick" type="text" placeholder="@username"/>

      <div class="hr"></div>

      <button id="btnSaveProfile" class="btn" type="button">–í–æ–π—Ç–∏ / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="msg" id="profileMsg"></div>

      <div class="hr"></div>

      <button id="btnMyBookings" class="btn secondary" type="button">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</button>

      <div class="hr"></div>

      <div class="tag" id="t_upcoming_tag">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
      <div id="upcomingList"></div>

      <div class="hr"></div>

      <div class="tag" id="t_past_tag">–ü—Ä–æ—à–µ–¥—à–∏–µ</div>
      <div id="pastList"></div>
    </div>
  </div>

  <script>
    const tg = (typeof window !== "undefined") ? window.Telegram?.WebApp : null;

    const MASTERS = [
      { id: 1, name: "Dilshod", photo: "./masters/dilshod.jpg" },
      { id: 2, name: "Daler",   photo: "./masters/daler.jpg" },
      { id: 3, name: "Azim",    photo: "./masters/azim.jpg" },
    ];

    // ‚úÖ –∑–∞–º–µ–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
    const SERVICES = [
      { id: 1,  key:"men_haircut", name_ru:"–ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞", name_uz:"Erkaklar soch turmagi", name_en:"Men's haircut", duration:45, price:70000 },
      { id: 2,  key:"kids_haircut", name_ru:"–î–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞ (–¥–æ 14–ª–µ—Ç)", name_uz:"Bolalar soch turmagi (14 yoshgacha)", name_en:"Kids haircut (up to 14)", duration:45, price:50000 },
      { id: 3,  key:"clipper", name_ru:"–ü–æ–¥ –Ω–∞—Å–∞–¥–∫—É", name_uz:"Mashinka bilan", name_en:"Clipper cut", duration:30, price:40000 },
      { id: 4,  key:"beard", name_ru:"–°—Ç—Ä–∏–∂–∫–∞ –ë–æ—Ä–æ–¥—ã", name_uz:"Soqol olish", name_en:"Beard trim", duration:30, price:50000 },
      { id: 5,  key:"styling", name_ru:"–£–∫–ª–∞–¥–∫–∞ –≤–æ–ª–æ—Å", name_uz:"Soch turmagi (ukladka)", name_en:"Hair styling", duration:20, price:40000 },
      { id: 6,  key:"edging", name_ru:"–û–∫–∞–Ω—Ç–æ–≤–∫–∞", name_uz:"Kontur (okantovka)", name_en:"Edging", duration:10, price:30000 },
      { id: 7,  key:"mask", name_ru:"–ú–∞—Å–∫–∞ –¥–ª—è –ª–∏—Ü–∞", name_uz:"Yuz niqobi", name_en:"Face mask", duration:30, price:40000 },
      { id: 8,  key:"wax", name_ru:"–í–æ—Å–∫", name_uz:"Vosk", name_en:"Wax", duration:20, price:15000 },
      { id: 9,  key:"hair_dye", name_ru:"–ü–æ–∫—Ä–∞—Å–∫–∞ –≤–æ–ª–æ—Å", name_uz:"Soch bo'yash", name_en:"Hair coloring", duration:40, price:40000 },
      { id: 10, key:"beard_dye", name_ru:"–ü–æ–∫—Ä–∞—Å–∫–∞ –±–æ—Ä–æ–¥—ã", name_uz:"Soqol bo'yash", name_en:"Beard coloring", duration:30, price:30000 },
      { id: 11, key:"wedding", name_ru:"–°–≤–∞–¥–µ–±–Ω–∞—è –ø—Ä–∏—á—ë—Å–∫–∞", name_uz:"To'y soch turmagi", name_en:"Wedding hairstyle", duration:60, price:400000 },
    ];

    const PROMOS = [
      { title: "–°–∫–∏–¥–∫–∞ 10% —Å—Ç—É–¥–µ–Ω—Ç–∞–º", text: "–ü—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ." },
      { title: "–ö–∞–∂–¥—ã–π 5-–π –≤–∏–∑–∏—Ç -20%", text: "–°–∫–∏–¥–∫–∞ –Ω–∞ —É—Å–ª—É–≥—É –ø–æ –∫–∞—Ä—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞." },
    ];

    const el = (id) => document.getElementById(id);

    const KEY_PROFILE = "tk_profile_v2";
    const KEY_BOOKINGS = "tk_bookings_v2";
    const KEY_LANG = "tk_lang_v1";

    function fmtSum(n){
      const x = Number(n) || 0;
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function todayISO(){
      const d = new Date();
      const p = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    }
    function normalizePhone(p){ return (p || "").trim().replace(/[^\d+]/g, ""); }
    function sheetOpen(backdrop){ backdrop.classList.add("show"); document.body.style.overflow="hidden"; }
    function sheetClose(backdrop){ backdrop.classList.remove("show"); document.body.style.overflow=""; }

    function loadProfile(){ try { return JSON.parse(localStorage.getItem(KEY_PROFILE) || "null"); } catch { return null; } }
    function saveProfile(p){ localStorage.setItem(KEY_PROFILE, JSON.stringify(p)); }
    function loadBookings(){ try { return JSON.parse(localStorage.getItem(KEY_BOOKINGS) || "[]"); } catch { return []; } }
    function saveBookings(arr){ localStorage.setItem(KEY_BOOKINGS, JSON.stringify(arr)); }

    function getLang(){
      return (localStorage.getItem(KEY_LANG) || "ru").toLowerCase();
    }
    function setLang(lang){
      localStorage.setItem(KEY_LANG, lang);
    }

    const I18N = {
      ru: {
        booking:"–ó–∞–ø–∏—Å—å",
        services:"–£—Å–ª—É–≥–∏",
        pickServices:"–í—ã–±–æ—Ä —É—Å–ª—É–≥",
        chooseServices:"–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏",
        notChosen:"–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —É—Å–ª—É–≥–∏",
        master:"–ú–∞—Å—Ç–µ—Ä",
        date:"–î–∞—Ç–∞",
        time:"–í—Ä–µ–º—è",
        name:"–ò–º—è",
        phone:"–¢–µ–ª–µ—Ñ–æ–Ω",
        comment:"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        commentPh:"–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ä–æ—Ç–∫–æ –ø–æ –±–æ–∫–∞–º",
        duration:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
        min:"–º–∏–Ω",
        total:"–°—É–º–º–∞",
        confirm:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å",
        pickServiceFirst:"–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É (–∫–Ω–æ–ø–∫–∞ ¬´–í—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏¬ª).",
        pickMaster:"–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞.",
        pickDate:"–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.",
        pickTime:"–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.",
        enterName:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è.",
        promos:"–ê–∫—Ü–∏–∏",
        contacts:"–ö–æ–Ω—Ç–∞–∫—Ç—ã",
        close:"–ó–∞–∫—Ä—ã—Ç—å",
        clear:"–°–±—Ä–æ—Å–∏—Ç—å",
        done:"–ì–æ—Ç–æ–≤–æ",
        profile:"–ü—Ä–æ—Ñ–∏–ª—å",
        lang:"–Ø–∑—ã–∫",
        loginPhone:"–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)",
        tgNick:"Telegram –Ω–∏–∫",
        save:"–í–æ–π—Ç–∏ / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        saved:"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.",
        enterPhoneOrNick:"–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram –Ω–∏–∫.",
        myBookings:"–ú–æ–∏ –∑–∞–ø–∏—Å–∏",
        upcoming:"–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ",
        past:"–ü—Ä–æ—à–µ–¥—à–∏–µ",
        noneUpcoming:"–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.",
        nonePast:"–ü—Ä–æ—à–µ–¥—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.",
        testHint:"‚úÖ (–¢–µ—Å—Ç) –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram WebApp —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å."
      },
      uz: {
        booking:"Yozilish",
        services:"Xizmatlar",
        pickServices:"Xizmat tanlash",
        chooseServices:"Xizmatlarni tanlash",
        notChosen:"Xizmat tanlanmagan",
        master:"Usta",
        date:"Sana",
        time:"Vaqt",
        name:"Ism",
        phone:"Telefon",
        comment:"Izoh",
        commentPh:"Masalan: yonlari qisqa",
        duration:"Davomiyligi",
        min:"daq",
        total:"Jami",
        confirm:"Yozilishni tasdiqlash",
        pickServiceFirst:"Xizmat tanlang (\"Xizmatlarni tanlash\" tugmasi).",
        pickMaster:"Ustani tanlang.",
        pickDate:"Sanani tanlang.",
        pickTime:"Vaqtni tanlang.",
        enterName:"Ism kiriting.",
        promos:"Aksiyalar",
        contacts:"Kontaktlar",
        close:"Yopish",
        clear:"Tozalash",
        done:"Tayyor",
        profile:"Profil",
        lang:"Til",
        loginPhone:"Telefon (kirish uchun)",
        tgNick:"Telegram nik",
        save:"Kirish / Saqlash",
        saved:"‚úÖ Ma'lumotlar saqlandi.",
        enterPhoneOrNick:"Telefon yoki Telegram nik kiriting.",
        myBookings:"Mening yozilishlarim",
        upcoming:"Kelajakdagi",
        past:"O‚Äòtgan",
        noneUpcoming:"Kelajakdagi yozilish yo‚Äòq.",
        nonePast:"O‚Äòtgan yozilish yo‚Äòq.",
        testHint:"‚úÖ (Test) Telegram WebApp orqali oching."
      },
      en: {
        booking:"Booking",
        services:"Services",
        pickServices:"Pick services",
        chooseServices:"Choose services",
        notChosen:"No services selected",
        master:"Master",
        date:"Date",
        time:"Time",
        name:"Name",
        phone:"Phone",
        comment:"Comment",
        commentPh:"For example: short on sides",
        duration:"Duration",
        min:"min",
        total:"Total",
        confirm:"Confirm booking",
        pickServiceFirst:"Choose a service (\"Choose services\" button).",
        pickMaster:"Choose a master.",
        pickDate:"Choose a date.",
        pickTime:"Choose time.",
        enterName:"Enter your name.",
        promos:"Promotions",
        contacts:"Contacts",
        close:"Close",
        clear:"Clear",
        done:"Done",
        profile:"Profile",
        lang:"Language",
        loginPhone:"Phone (login)",
        tgNick:"Telegram username",
        save:"Login / Save",
        saved:"‚úÖ Saved.",
        enterPhoneOrNick:"Enter phone or Telegram username.",
        myBookings:"My bookings",
        upcoming:"Upcoming",
        past:"Past",
        noneUpcoming:"No upcoming bookings.",
        nonePast:"No past bookings.",
        testHint:"‚úÖ (Test) Open via Telegram WebApp to send."
      }
    };

    function svcNameByLang(s, lang){
      if (lang === "uz") return s.name_uz;
      if (lang === "en") return s.name_en;
      return s.name_ru;
    }

    function parseBookingDateTimeISO(dateStr, timeStr){
      // date: YYYY-MM-DD, time: HH:MM
      const [y,m,d] = dateStr.split("-").map(Number);
      const [hh,mm] = timeStr.split(":").map(Number);
      // Local time
      return new Date(y, (m-1), d, hh, mm, 0, 0).getTime();
    }

    document.addEventListener("DOMContentLoaded", () => {
      // elements
      const mastersRow = el("mastersRow");

      const btnServices = el("btnServices");
      const servicesHint = el("servicesHint");
      const servicesBackdrop = el("servicesBackdrop");
      const servicesClose = el("servicesClose");
      const servicesGrid = el("servicesGrid");
      const servicesClear = el("servicesClear");
      const servicesDone = el("servicesDone");

      const dateEl = el("date");
      const timeEl = el("time");
      const nameEl = el("name");
      const phoneEl = el("phone");
      const commentEl = el("comment");
      const durEl = el("dur");
      const sumEl = el("sum");
      const msgEl = el("msg");
      const promosEl = el("promos");
      const btnSend = el("btnSend");

      const fabProfile = el("fabProfile");
      const profileWindow = el("profileWindow");
      const profileClose = el("profileClose");
      const profilePhone = el("profilePhone");
      const profileNick = el("profileNick");
      const btnSaveProfile = el("btnSaveProfile");
      const profileMsg = el("profileMsg");
      const btnMyBookings = el("btnMyBookings");
      const upcomingList = el("upcomingList");
      const pastList = el("pastList");
      const tgTag = el("tgTag");
      const langSeg = el("langSeg");

      // i18n targets
      const t = {
        booking: el("t_booking"),
        services: el("t_services"),
        master: el("t_master"),
        date: el("t_date"),
        time: el("t_time"),
        name: el("t_name"),
        phone: el("t_phone"),
        comment: el("t_comment"),
        duration: el("t_duration"),
        min: el("t_min"),
        total: el("t_total"),
        promos: el("t_promos"),
        contacts: el("t_contacts"),
        servicesPick: el("t_services_pick"),
        upcomingTag: el("t_upcoming_tag"),
        pastTag: el("t_past_tag"),
        profile: el("t_profile"),
        lang: el("t_lang"),
        loginPhone: el("t_login_phone"),
        loginNick: el("t_login_nick"),
      };

      if (tg) {
        tg.ready();
        tg.expand();
        try { tg.setHeaderColor && tg.setHeaderColor("#0b0b0c"); } catch(e){}
        try { tg.setBackgroundColor && tg.setBackgroundColor("#0b0b0c"); } catch(e){}
      }

      let selectedServices = new Set();
      let selectedMasterId = null;

      function setMsg(t){ msgEl.textContent = t || ""; }

      function getStrings(){
        const lang = getLang();
        return I18N[lang] || I18N.ru;
      }

      function applyLang(){
        const s = getStrings();
        t.booking.textContent = s.booking;
        t.services.textContent = s.services;
        t.master.textContent = s.master;
        t.date.textContent = s.date;
        t.time.textContent = s.time;
        t.name.textContent = s.name;
        t.phone.textContent = s.phone;
        t.comment.textContent = s.comment;
        t.duration.textContent = s.duration;
        t.min.textContent = s.min;
        t.total.textContent = s.total;
        t.promos.textContent = s.promos;
        t.contacts.textContent = s.contacts;

        t.servicesPick.textContent = s.pickServices;
        btnServices.textContent = s.chooseServices;

        commentEl.placeholder = s.commentPh;

        servicesClose.textContent = s.close;
        servicesClear.textContent = s.clear;
        servicesDone.textContent = s.done;

        t.profile.textContent = s.profile;
        profileClose.textContent = s.close;
        t.lang.textContent = s.lang;
        t.loginPhone.textContent = s.loginPhone;
        t.loginNick.textContent = s.tgNick;
        btnSaveProfile.textContent = s.save;
        btnMyBookings.textContent = s.myBookings;
        t.upcomingTag.textContent = s.upcoming;
        t.pastTag.textContent = s.past;

        btnSend.textContent = s.confirm;

        // segmented active
        [...langSeg.querySelectorAll("button")].forEach(b => {
          b.classList.toggle("active", b.dataset.lang === getLang());
        });

        // re-render services names + hint + lists
        renderServicesSheet();
        calc();
        renderBookings();
      }

      function calc(){
        let total = 0, dur = 0;
        const chosen = [];
        const lang = getLang();

        for (const id of selectedServices) {
          const s = SERVICES.find(x => x.id === id);
          if (!s) continue;
          total += s.price;
          dur += s.duration;
          chosen.push({
            id: s.id,
            key: s.key,
            name: svcNameByLang(s, lang),
            price: s.price,
            duration: s.duration,
            qty: 1
          });
        }

        durEl.textContent = dur ? String(dur) : "‚Äî";
        sumEl.textContent = total ? `${fmtSum(total)} so'm` : "‚Äî";

        const str = getStrings();
        if (!chosen.length) servicesHint.textContent = str.notChosen;
        else servicesHint.textContent = chosen.map(x => x.name).join(" ‚Ä¢ ");

        return { total, dur, chosen };
      }

      function buildTimes(){
        const start = 9*60, end = 22*60, step = 30;
        timeEl.innerHTML = "";
        for (let t=start; t<end; t+=step){
          const h = String(Math.floor(t/60)).padStart(2,"0");
          const m = String(t%60).padStart(2,"0");
          const opt = document.createElement("option");
          opt.value = `${h}:${m}`;
          opt.textContent = `${h}:${m}`;
          timeEl.appendChild(opt);
        }
      }

      // ‚úÖ —É—Å–ª—É–≥–∏: 2 –≤ —Ä—è–¥ + –±–µ–∑ —ç–º–æ–¥–∑–∏
      function renderServicesSheet(){
        servicesGrid.innerHTML = "";
        const lang = getLang();
        SERVICES.forEach(s => {
          const d = document.createElement("div");
          d.className = "svcCard" + (selectedServices.has(s.id) ? " active" : "");
          d.innerHTML = `
            <div class="svcName">${svcNameByLang(s, lang)}</div>
            <div class="svcSub">
              <span>${fmtSum(s.price)} so'm</span>
              <span>${s.duration} ${getStrings().min}</span>
            </div>
          `;
          d.onclick = () => {
            if (selectedServices.has(s.id)) selectedServices.delete(s.id);
            else selectedServices.add(s.id);
            renderServicesSheet();
            calc();
          };
          servicesGrid.appendChild(d);
        });
      }

      btnServices.onclick = () => { renderServicesSheet(); sheetOpen(servicesBackdrop); };
      servicesClose.onclick = () => sheetClose(servicesBackdrop);
      servicesBackdrop.addEventListener("click", (e) => { if (e.target === servicesBackdrop) sheetClose(servicesBackdrop); });

      servicesClear.onclick = () => { selectedServices = new Set(); renderServicesSheet(); calc(); };
      servicesDone.onclick = () => sheetClose(servicesBackdrop);

      // ‚úÖ –º–∞—Å—Ç–µ—Ä–∞: –∏–∫–æ–Ω–∫–∏ —Å —Ñ–æ—Ç–æ –≤ —Ä—è–¥
      function renderMasters(){
        mastersRow.innerHTML = "";
        MASTERS.forEach(m => {
          const c = document.createElement("div");
          c.className = "mcard" + (selectedMasterId === m.id ? " active" : "");
          c.innerHTML = `
            <img class="mava" src="${m.photo}" alt="${m.name}"
              onerror="this.style.opacity='.45'; this.style.filter='grayscale(1)';"/>
            <div class="mname">${m.name}</div>
            <div class="msub">–º–∞—Å—Ç–µ—Ä</div>
          `;
          c.onclick = () => {
            selectedMasterId = m.id;
            renderMasters();
            setMsg("");
          };
          mastersRow.appendChild(c);
        });
      }

      // promos
      promosEl.innerHTML = "";
      PROMOS.forEach(p => {
        const d = document.createElement("div");
        d.className = "promo";
        d.innerHTML = `<b>${p.title}</b><div>${p.text}</div>`;
        promosEl.appendChild(d);
      });

      // Telegram tag
      function fillTelegramTag(){
        const u = tg?.initDataUnsafe?.user;
        const nick = u?.username ? ("@" + u.username) : "‚Äî";
        tgTag.textContent = "Telegram: " + nick;
      }
      fillTelegramTag();

      // ‚úÖ language buttons
      langSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-lang]");
        if (!btn) return;
        setLang(btn.dataset.lang);
        // also store inside profile for convenience
        const prof = loadProfile() || {};
        prof.lang = getLang();
        saveProfile(prof);
        applyLang();
      });

      // ‚úÖ Profile window open/close (–¥—Ä—É–≥–æ–µ –æ–∫–Ω–æ)
      function openProfile(){
        const prof = loadProfile();
        const u = tg?.initDataUnsafe?.user;

        profilePhone.value = prof?.phone || "";
        profileNick.value = prof?.nick || (u?.username ? ("@" + u.username) : "");
        profileMsg.textContent = (prof?.phone || prof?.nick) ? getStrings().saved : getStrings().enterPhoneOrNick;

        // if profile has saved lang -> apply
        if (prof?.lang && (prof.lang === "ru" || prof.lang === "uz" || prof.lang === "en")) {
          setLang(prof.lang);
        }
        applyLang();
        renderBookings();
        sheetOpen(profileWindow);
      }

      fabProfile.onclick = openProfile;
      profileClose.onclick = () => sheetClose(profileWindow);
      profileWindow.addEventListener("click", (e) => { if (e.target === profileWindow) sheetClose(profileWindow); });

      btnSaveProfile.onclick = () => {
        const phone = normalizePhone(profilePhone.value);
        const nick = (profileNick.value || "").trim();
        if (!phone && !nick){
          profileMsg.textContent = getStrings().enterPhoneOrNick;
          return;
        }
        saveProfile({
          phone,
          nick,
          lang: getLang(),
          updated_at: Date.now()
        });
        profileMsg.textContent = getStrings().saved;
      };

      // ‚úÖ –º–æ–∏ –∑–∞–ø–∏—Å–∏: –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ / –ø—Ä–æ—à–µ–¥—à–∏–µ, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
      function bookingCardHTML(x){
        const svc = (x.services || []).map(s => s.name).join(", ");
        return `
          <div class="bcard">
            <div class="btop">
              <div>${x.date} ${x.time}</div>
              <div>${fmtSum(x.total)} so'm</div>
            </div>
            <div class="btitle">${x.master_name || "‚Äî"}</div>
            <div class="bsub">${svc || ""}</div>
          </div>
        `;
      }

      function renderBookings(){
        const str = getStrings();
        const list = loadBookings();
        const now = Date.now();

        const withTs = list.map(b => {
          const ts = (b.datetime_ts != null)
            ? Number(b.datetime_ts)
            : (b.date && b.time ? parseBookingDateTimeISO(b.date, b.time) : 0);
          return { ...b, datetime_ts: ts };
        });

        // persist back if missing ts
        saveBookings(withTs);

        const upcoming = withTs
          .filter(b => (b.datetime_ts || 0) >= (now - 5*60*1000))
          .sort((a,b)=> (a.datetime_ts||0) - (b.datetime_ts||0));

        const past = withTs
          .filter(b => (b.datetime_ts || 0) < (now - 5*60*1000))
          .sort((a,b)=> (b.datetime_ts||0) - (a.datetime_ts||0));

        upcomingList.innerHTML = upcoming.length ? upcoming.map(bookingCardHTML).join("") : `<div class="msg">${str.noneUpcoming}</div>`;
        pastList.innerHTML = past.length ? past.map(bookingCardHTML).join("") : `<div class="msg">${str.nonePast}</div>`;
      }

      btnMyBookings.onclick = renderBookings;

      // init defaults
      // saved language first
      const prof0 = loadProfile();
      if (prof0?.lang) setLang(prof0.lang);

      dateEl.value = todayISO();
      buildTimes();
      renderMasters();
      applyLang();

      const u = tg?.initDataUnsafe?.user;
      if (u?.first_name && !nameEl.value) nameEl.value = u.first_name;

      // send booking
      btnSend.onclick = () => {
        const str = getStrings();
        const { total, dur, chosen } = calc();

        if (!chosen.length) return setMsg(str.pickServiceFirst);
        if (!selectedMasterId) return setMsg(str.pickMaster);
        if (!dateEl.value) return setMsg(str.pickDate);
        if (!timeEl.value) return setMsg(str.pickTime);
        if (!nameEl.value.trim()) return setMsg(str.enterName);

        const masterName = (MASTERS.find(m => m.id === selectedMasterId)?.name) || "‚Äî";

        const payload = {
          booking_id: "BK-" + Date.now(),
          client_name: nameEl.value.trim(),
          phone: normalizePhone(phoneEl.value),
          comment: commentEl.value.trim(),
          master_id: selectedMasterId,
          master_name: masterName,
          date: dateEl.value,
          time: timeEl.value,
          services: chosen,
          total: total,
          duration_min: dur,
          client_ts: Date.now(),
          lang: getLang(),
          datetime_ts: parseBookingDateTimeISO(dateEl.value, timeEl.value),
        };

        // save locally
        const list = loadBookings();
        list.push(payload);
        saveBookings(list);

        if (tg) {
          tg.sendData(JSON.stringify(payload));
          tg.close();
        } else {
          console.log("Payload:", payload);
          setMsg(str.testHint);
        }
      };
    });
  </script>
</body>
</html>
