<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>THE KINGS ‚Äî –ó–∞–ø–∏—Å—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;
      --stroke:rgba(255,255,255,.10);
      --text:#f5f5f7;
      --muted:rgba(255,255,255,.72);
      --gold:#d4a017;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:520px;margin:0 auto;padding:14px 12px 40px}
    .top{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:56px;height:56px;border-radius:16px;object-fit:cover;border:1px solid var(--stroke)}
    h1{margin:0;font-size:22px}
    p{margin:2px 0 0;color:var(--muted);font-weight:700;letter-spacing:2px}
    .card{border:1px solid var(--stroke);border-radius:18px;padding:14px;margin:12px 0;background:rgba(255,255,255,.04)}
    h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;background:rgba(0,0,0,.22);color:var(--text);border:1px solid var(--stroke);border-radius:12px;padding:10px;outline:none}
    textarea{resize:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chip{border:1px solid var(--stroke);border-radius:14px;padding:10px;background:rgba(0,0,0,.18);cursor:pointer;user-select:none}
    .chip-sub{color:rgba(255,255,255,.72);font-size:12px;margin-top:4px}
    .chip.active{border-color:rgba(212,160,23,.7);box-shadow:0 0 0 2px rgba(212,160,23,.18) inset}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .summary{display:flex;justify-content:space-between;color:var(--muted);margin:12px 0}
    .btn{width:100%;border:0;border-radius:14px;padding:12px;background:linear-gradient(180deg, rgba(212,160,23,.96), rgba(180,130,10,.96));font-weight:900;cursor:pointer;color:#111}
    .msg{margin-top:10px;color:var(--muted);font-size:13px}
    .promo{border:1px dashed rgba(212,160,23,.35);border-radius:14px;padding:10px;margin:8px 0;background:rgba(212,160,23,.06)}
    .contacts{color:var(--muted);line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <img class="logo" src="./logo.jpg" alt="THE KINGS"/>
      <div>
        <h1>THE KINGS</h1>
        <p>BARBERSHOP</p>
      </div>
    </header>

    <div class="card">
      <h2>–ó–∞–ø–∏—Å—å</h2>

      <label>–£—Å–ª—É–≥–∏</label>
      <div id="services" class="grid"></div>

      <label>–ú–∞—Å—Ç–µ—Ä</label>
      <select id="master"></select>

      <div class="row">
        <div class="col">
          <label>–î–∞—Ç–∞</label>
          <input id="date" type="date"/>
        </div>
        <div class="col">
          <label>–í—Ä–µ–º—è</label>
          <select id="time"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>–ò–º—è</label>
          <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è"/>
        </div>
        <div class="col">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" type="tel" placeholder="+998 __ ___ __ __"/>
        </div>
      </div>

      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—Ä–æ—Ç–∫–æ –ø–æ –±–æ–∫–∞–º"></textarea>

      <div class="summary">
        <div>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <b id="dur">‚Äî</b> –º–∏–Ω</div>
        <div>–°—É–º–º–∞: <b id="sum">‚Äî</b></div>
      </div>

      <button id="btnSend" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2>–ê–∫—Ü–∏–∏</h2>
      <div id="promos"></div>
    </div>

    <div class="card">
      <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
      <div class="contacts">
        <div><b>THE KINGS BARBERSHOP</b></div>
        <div>üìç –≥. –°–∞–º–∞—Ä–∫–∞–Ω–¥, –£–ª–∏—Ü–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω—Å–∫–∞—è, 84</div>
        <div>üïò 09:00-22:00</div>
        <div>‚òéÔ∏è +998 98 001 21 07 / +998 90 601 73 71</div>
        <div>Instagram: @thekings_barbershop_sam</div>
      </div>
    </div>
  </div>

  <script>
    const tg = (typeof window !== "undefined") ? window.Telegram?.WebApp : null;

    const MASTERS = [
      { id: 1, name: "Aziz" },
      { id: 2, name: "Javohir" },
      { id: 3, name: "Sardor" },
    ];

    const SERVICES = [
      { id: 1, name: "–°—Ç—Ä–∏–∂–∫–∞", duration: 45, price: 60000 },
      { id: 2, name: "–ë–æ—Ä–æ–¥–∞", duration: 30, price: 40000 },
      { id: 3, name: "–°—Ç—Ä–∏–∂–∫–∞ + –ë–æ—Ä–æ–¥–∞", duration: 75, price: 90000 },
      { id: 4, name: "–£–∫–ª–∞–¥–∫–∞", duration: 20, price: 25000 },
    ];

    const PROMOS = [
      { title: "–°–∫–∏–¥–∫–∞ 10% —Å—Ç—É–¥–µ–Ω—Ç–∞–º", text: "–ü—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ." },
      { title: "–ö–∞–∂–¥—ã–π 5-–π –≤–∏–∑–∏—Ç -20%", text: "–°–∫–∏–¥–∫–∞ –Ω–∞ —É—Å–ª—É–≥—É –ø–æ –∫–∞—Ä—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞." },
    ];

    const el = (id) => document.getElementById(id);

    function todayISO(){
      const d = new Date();
      const p = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
    }
    function fmtSum(n){
      const x = Number(n) || 0;
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const servicesEl = el("services");
      const masterEl = el("master");
      const dateEl = el("date");
      const timeEl = el("time");
      const nameEl = el("name");
      const phoneEl = el("phone");
      const commentEl = el("comment");
      const durEl = el("dur");
      const sumEl = el("sum");
      const msgEl = el("msg");
      const promosEl = el("promos");
      const btnSend = el("btnSend");

      if (tg) { tg.ready(); tg.expand(); }

      let selected = new Set();

      function calc(){
        let total = 0, dur = 0;
        const chosen = [];
        for (const id of selected) {
          const s = SERVICES.find(x => x.id === id);
          if (!s) continue;
          total += s.price;
          dur += s.duration;
          chosen.push({ id: s.id, name: s.name, price: s.price, duration: s.duration, qty: 1 });
        }
        durEl.textContent = dur ? String(dur) : "‚Äî";
        sumEl.textContent = total ? `${fmtSum(total)} so'm` : "‚Äî";
        return { total, dur, chosen };
      }

      function buildTimes(){
        const start = 9*60, end = 22*60, step = 30;
        timeEl.innerHTML = "";
        for (let t=start; t<end; t+=step){
          const h = String(Math.floor(t/60)).padStart(2,"0");
          const m = String(t%60).padStart(2,"0");
          const opt = document.createElement("option");
          opt.value = `${h}:${m}`;
          opt.textContent = `${h}:${m}`;
          timeEl.appendChild(opt);
        }
      }

      // —É—Å–ª—É–≥–∏
      servicesEl.innerHTML = "";
      SERVICES.forEach(s => {
        const div = document.createElement("div");
        div.className = "chip";
        div.innerHTML = `<b>${s.name}</b><div class="chip-sub">${fmtSum(s.price)} so'm ‚Ä¢ ${s.duration} –º–∏–Ω</div>`;
        div.onclick = () => {
          if (selected.has(s.id)) { selected.delete(s.id); div.classList.remove("active"); }
          else { selected.add(s.id); div.classList.add("active"); }
          calc();
        };
        servicesEl.appendChild(div);
      });

      // –º–∞—Å—Ç–µ—Ä–∞
      masterEl.innerHTML = "";
      const def = document.createElement("option");
      def.value = "";
      def.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞";
      masterEl.appendChild(def);
      MASTERS.forEach(m => {
        const o = document.createElement("option");
        o.value = String(m.id);
        o.textContent = m.name;
        masterEl.appendChild(o);
      });

      // –∞–∫—Ü–∏–∏
      promosEl.innerHTML = "";
      PROMOS.forEach(p => {
        const d = document.createElement("div");
        d.className = "promo";
        d.innerHTML = `<b>${p.title}</b><div>${p.text}</div>`;
        promosEl.appendChild(d);
      });

      dateEl.value = todayISO();
      buildTimes();

      const u = tg?.initDataUnsafe?.user;
      if (u?.first_name && !nameEl.value) nameEl.value = u.first_name;

      calc();

      function setMsg(t){ msgEl.textContent = t || ""; }
      function normalizePhone(p){ return (p || "").trim().replace(/[^\d+]/g, ""); }

      btnSend.onclick = () => {
        const { total, dur, chosen } = calc();

        if (!chosen.length) return setMsg("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É.");
        if (!masterEl.value) return setMsg("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞.");
        if (!dateEl.value) return setMsg("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.");
        if (!timeEl.value) return setMsg("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.");
        if (!nameEl.value.trim()) return setMsg("–í–≤–µ–¥–∏—Ç–µ –∏–º—è.");

        const masterId = Number(masterEl.value);
        const masterName = (MASTERS.find(m => m.id === masterId)?.name) || "‚Äî";

        const payload = {
          booking_id: "BK-" + Date.now(),
          client_name: nameEl.value.trim(),
          phone: normalizePhone(phoneEl.value),
          comment: commentEl.value.trim(),
          master_id: masterId,
          master_name: masterName,
          date: dateEl.value,
          time: timeEl.value,
          services: chosen,
          total: total,
          duration_min: dur,
          client_ts: Date.now(),
        };

        if (tg) {
          tg.sendData(JSON.stringify(payload));
          tg.close();
        } else {
          console.log("Payload:", payload);
          setMsg("‚úÖ (–¢–µ—Å—Ç) –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram WebApp —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.");
        }
      };
    });
  </script>
</body>
</html>
